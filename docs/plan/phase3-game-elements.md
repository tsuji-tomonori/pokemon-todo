# Phase 3: ゲーム要素

**期間**: 5-6日
**目標**: バトルシステムと経験値システム実装、ゲーミフィケーション完成

## 概要

ポケモン風TODOアプリの最も特徴的な機能である、バトルシステム（一方向攻撃型）と経験値・レベルアップシステムを実装します。これによりタスク管理がゲーム的な楽しさを持つようになります。

## Day 1: バトルシステム基盤実装

### Battle Model & API (4-5時間)

#### Battle データモデル
- [ ] `models/battle.py` - Battle SQLAlchemyモデル
  - バトル記録データ（[要件定義書](../../requirements.md) 4章参照）
  - ポケモンとの関連設定
  - バトル統計情報

#### Battle API実装
- [ ] `api/v1/battles.py`
  - `GET /api/v1/pokemon/{id}/current-battle` - 現在のバトル状態
  - `POST /api/v1/battles/{id}/complete` - バトル完了処理
  - `GET /api/v1/battles/history` - バトル履歴

#### Battle Service
- [ ] `services/battle_service.py` - バトル処理ロジック
  - 一方向バトル仕様（敵は反撃しない）
  - 勝利条件判定（常に勝利）
  - ダメージ計算
  - 経験値計算

**成果物**: バトル基盤システム

### Experience System (3-4時間)

#### Experience Service実装
- [ ] `services/experience_service.py`
  - レベル計算アルゴリズム
  - 経験値テーブル定義
  - 進化判定ロジック
  - レベルアップ処理

#### Pokemon Model拡張
- [ ] レベル・経験値関連フィールド追加
- [ ] 進化段階管理
- [ ] マイグレーション作成・実行

**成果物**: 経験値・レベルシステム

### 動作テスト (1時間)
- [ ] バトル作成・完了フロー確認
- [ ] 経験値・レベル計算テスト
- [ ] データ整合性確認

## Day 2: Move実行システム

### Move Execute API (4-5時間)

#### わざ実行エンドポイント
- [ ] `POST /api/v1/moves/{id}/execute` 実装
  - わざ完了処理
  - バトルダメージ計算
  - 敵HP更新
  - 勝利判定

#### 統合処理フロー
- [ ] わざ実行 → ダメージ → バトル更新 → 経験値獲得
- [ ] トランザクション管理
- [ ] エラー処理強化

**成果物**: 完全なわざ実行システム

### Frontend Battle Store (4-5時間)

#### Battle状態管理
- [ ] `stores/battleStore.ts` 実装（[状態管理MADR](../madr/0003-state-management.md)参照）
  - バトル開始・終了
  - 敵HP管理
  - ダメージ計算
  - アニメーション Queue

#### Battle Hooks
- [ ] `hooks/useBattle.ts` - バトル操作
- [ ] `hooks/useExperience.ts` - 経験値操作
- [ ] API統合

**成果物**: Frontend バトル管理

## Day 3: Battle UI実装

### Battle画面コンポーネント (5-6時間)

#### Core Battle Components
- [ ] `components/battle/BattleScreen.tsx` - メインバトル画面
- [ ] `components/battle/HPBar.tsx` - HPバー表示
- [ ] `components/battle/DamageDisplay.tsx` - ダメージ表示
- [ ] `components/battle/MoveSelector.tsx` - わざ選択

#### Battle Layout
- [ ] 敵・味方の表示エリア
- [ ] わざ選択UI（4分割グリッド）
- [ ] バトル情報表示
- [ ] 進行状況表示

**成果物**: バトル画面UI

### Experience UI (3-4時間)

#### Experience Components
- [ ] `components/pokemon/ExperienceBar.tsx` - 経験値バー
- [ ] `components/battle/VictoryModal.tsx` - 勝利演出
- [ ] レベルアップ通知UI
- [ ] 進化通知UI

**成果物**: 経験値・成長UI

## Day 4: バトルアニメーション基盤

### Animation System基盤 (5-6時間)

#### Battle Animation Hook
- [ ] `hooks/useBattleAnimation.ts`（[アニメーションMADR](../madr/0004-animation-strategy.md)参照）
  - アニメーションシーケンス管理
  - わざ使用アニメーション
  - ダメージエフェクト
  - 勝利演出

#### Animation Components
- [ ] `components/battle/BattleAnimation.tsx` - アニメーション制御
- [ ] 基本的な揺れ・フラッシュエフェクト
- [ ] HPバー減少アニメーション
- [ ] 経験値バー上昇アニメーション

**成果物**: バトルアニメーション基盤

### 基本エフェクト実装 (3-4時間)

#### Visual Effects
- [ ] 攻撃時の画面揺れ
- [ ] ダメージ数値のポップアップ
- [ ] HPバー段階的減少
- [ ] レベルアップ時の光エフェクト

#### Sound Integration準備
- [ ] サウンドファイル配置
- [ ] 再生システム基盤
- [ ] ボリューム制御

**成果物**: 基本バトルエフェクト

## Day 5: Enemy・進化システム

### Enemy System (4-5時間)

#### Enemy データ
- [ ] 敵キャラクターデータ定義
- [ ] 敵生成ロジック
- [ ] 難易度別敵設定
- [ ] ランダム敵選出システム

#### Enemy API
- [ ] `api/v1/enemies.py`
  - 敵一覧取得
  - ランダム敵生成
  - 敵情報取得

**成果物**: 敵システム

### Evolution System (3-4時間)

#### Evolution Logic
- [ ] 進化条件定義
- [ ] 進化トリガー処理
- [ ] 進化データ管理
- [ ] 進化演出準備

#### Evolution Components
- [ ] 進化通知モーダル
- [ ] 進化前後比較表示
- [ ] 進化アニメーション基盤

**成果物**: 進化システム

### 統合テスト (1-2時間)
- [ ] バトル→勝利→経験値→レベルアップ→進化 フロー
- [ ] 各種エラーケーステスト
- [ ] パフォーマンス確認

## Day 6: ポリッシュと最適化

### ゲームバランス調整 (3-4時間)

#### バランシング
- [ ] 経験値テーブル調整
- [ ] わざ威力とダメージバランス
- [ ] レベルアップ必要経験値調整
- [ ] 敵の強さ調整

#### データ分析
- [ ] バトル統計表示
- [ ] 進捗可視化
- [ ] 達成度表示

**成果物**: バランス調整済みゲームシステム

### UI/UXポリッシュ (4-5時間)

#### ゲーミフィケーション演出
- [ ] レベルアップ時の豪華な演出
- [ ] 勝利時のお祝いアニメーション
- [ ] 進化時の特別演出
- [ ] 達成感のあるフィードバック

#### 操作性改善
- [ ] わざ選択の直感的操作
- [ ] バトル進行のテンポ調整
- [ ] 中断・再開機能
- [ ] バトルスキップ機能

**成果物**: 楽しいゲーム体験

### パフォーマンス最適化 (1-2時間)
- [ ] アニメーション最適化
- [ ] メモリ使用量確認
- [ ] バトル処理速度改善

## 完了基準

### 機能要件
- [ ] わざ実行でバトルが進行
- [ ] 敵を倒すと経験値獲得・レベルアップ
- [ ] 一定レベルで進化発生
- [ ] バトル履歴の記録・表示
- [ ] 適切なゲームバランス

### 技術要件
- [ ] バトルアニメーションが滑らか
- [ ] 状態管理が適切
- [ ] エラーハンドリングが堅牢
- [ ] パフォーマンスが許容範囲

### UX要件
- [ ] バトルが楽しく感じられる
- [ ] 成長が実感できる
- [ ] 操作が直感的
- [ ] フィードバックが適切

## 技術的詳細

### ゲーム設計原則
- **シンプルさ優先**: 複雑なルールは避ける
- **必ず勝利**: ストレスのないゲーム体験
- **即座の報酬**: タスク完了の即時フィードバック
- **視覚的楽しさ**: アニメーションと演出重視

### バトル仕様（要件定義書準拠）
- **一方向攻撃**: 敵は反撃しない
- **威力1-100**: AI計算による威力設定
- **常に勝利**: 失敗パターンなし
- **経験値獲得**: 勝利時に必ず獲得

## パフォーマンス目標
- **バトル開始**: 1秒以内
- **わざ実行**: 500ms以内の応答
- **アニメーション**: 60fps維持

## トラブルシューティング

### バトル関連
1. **アニメーション重い**: GPU加速確認
2. **状態同期エラー**: Battle Store確認
3. **経験値計算異常**: アルゴリズム検証

### データ関連
1. **バトル履歴異常**: トランザクション確認
2. **レベル計算エラー**: 経験値テーブル確認
3. **進化判定ミス**: 進化条件確認

## 次のステップ

Phase3完了後は[Phase4: UI/UX向上](./phase4-ui-ux.md)で洗練されたユーザー体験を実装します。

---

**参照ドキュメント**:
- [要件定義書 - バトルシステム](../../requirements.md#32-バトルシステム)
- [アニメーション戦略MADR](../madr/0004-animation-strategy.md)
- [状態管理戦略MADR](../madr/0003-state-management.md)
